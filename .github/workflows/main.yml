name: Deploy CinemaHub Auth Service

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  ACR_NAME: "myconvit"
  IMAGE_NAME: "cinemahub-auth"
  CONTAINER_APP_NAME: "cinemahub-auth-app"
  CONTAINER_APP_ENVIRONMENT: "Production"
  RESOURCE_GROUP: "test-group"
  LOCATION: "northeurope"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üîê Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: üöÄ Build and deploy Container App
      uses: azure/container-apps-deploy-action@v2
      with:
        appSourcePath: ${{ github.workspace }}
        
        acrName: ${{ env.ACR_NAME }}
        acrUsername: ${{ secrets.REGISTRY_USERNAME }}
        acrPassword: ${{ secrets.REGISTRY_PASSWORD }}
        
        containerAppName: ${{ env.CONTAINER_APP_NAME }}
        containerAppEnvironment: ${{ env.CONTAINER_APP_ENVIRONMENT }}
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        location: ${{ env.LOCATION }}
        
        imageToBuild: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
        dockerfilePath: Dockerfile
        
        targetPort: 8080
