name: Deploy to Azure Container Apps

on:

  push:
    branches: [ main ]
    
  pull_request:
    branches: [ main ]
    
  workflow_dispatch:

env:
  CONTAINER_APP_NAME: "my-app-container"
  
  CONTAINER_APP_ENVIRONMENT: "my-app-env"

  RESOURCE_GROUP: "test-group"

  ACR_NAME: "myconvitas"

  IMAGE_NAME: "myconvitas.azurecr.io/my-application:abc123"

  LOCATION: "northeurope"


jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      
    - name: üîê Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ‚úÖ Verify Azure connection
      run: |
        echo "Current Azure subscription:"
        az account show --output table
        echo "Available resource groups:"
        az group list --output table
    
    - name: üöÄ Build and deploy Container App
      uses: azure/container-apps-deploy-action@v2
      with:
        # ===== –ò–°–•–û–î–ù–´–ô –ö–û–î =====
        # –ü—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∫–æ–¥—É (–∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)
        appSourcePath: ${{ github.workspace }}
        
        # ===== CONTAINER REGISTRY =====
        # –ò–º—è –≤–∞—à–µ–≥–æ Azure Container Registry
        acrName: ${{ env.ACR_NAME }}
        # –õ–æ–≥–∏–Ω –¥–ª—è Container Registry (–∏–∑ GitHub Secrets)
        acrUsername: ${{ secrets.REGISTRY_USERNAME }}
        # –ü–∞—Ä–æ–ª—å –¥–ª—è Container Registry (–∏–∑ GitHub Secrets)  
        acrPassword: ${{ secrets.REGISTRY_PASSWORD }}
        
        # ===== AZURE –†–ï–°–£–†–°–´ =====
        # –ò–º—è Container App
        containerAppName: ${{ env.CONTAINER_APP_NAME }}

        containerAppEnvironment: ${{ env.CONTAINER_APP_ENVIRONMENT }}

        resourceGroup: ${{ env.RESOURCE_GROUP }}

        location: ${{ env.LOCATION }}
        
        imageToBuild: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
        # –ü—É—Ç—å –∫ Dockerfile (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)
        dockerfilePath: ./AuthenticationAndAuthorization/AuthenticationAndAuthorization/Dockerfile
        
        targetPort: 8080
        
        environmentVariables: 'ENVIRONMENT=production NODE_ENV=production'
