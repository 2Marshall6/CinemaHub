name: Deploy to Azure Container Apps

on:

  push:
    branches: [ main ]
    
  pull_request:
    branches: [ main ]
    
  workflow_dispatch:

env:
  # –ò–º—è –≤–∞—à–µ–≥–æ Container App (–±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
  CONTAINER_APP_NAME: "my-app-container"
  
  # –ò–º—è –æ–∫—Ä—É–∂–µ–Ω–∏—è Container App
  CONTAINER_APP_ENVIRONMENT: "my-app-env"
  
  # –ì—Ä—É–ø–ø–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ Azure
  RESOURCE_GROUP: "test-group"
  
  # –í–∞—à Container Registry (—É–∂–µ —Å–æ–∑–¥–∞–Ω)
  ACR_NAME: "myconvitas"
  
  # –ò–º—è Docker –æ–±—Ä–∞–∑–∞
  IMAGE_NAME: "myconvitas.azurecr.io/my-application:abc123"
  
  # –†–µ–≥–∏–æ–Ω Azure –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
  LOCATION: "East US"

# 4. –î–ñ–û–ë–´ (–ó–ê–î–ê–ß–ò) - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ workflow
jobs:
  # ===========================================================================
  # JOB 1: –°–ë–û–†–ö–ê –ò –î–ï–ü–õ–û–ô
  # ===========================================================================
  build-and-deploy:
    # –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    runs-on: ubuntu-latest
    
    # –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    steps:
    
    # –®–ê–ì 1: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      
    # –®–ê–ì 2: –í—Ö–æ–¥ –≤ Azure —Å –ø–æ–º–æ—â—å—é Service Principal
    - name: üîê Log in to Azure
      uses: azure/login@v1
      with:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–∫—Ä–µ—Ç AZURE_CREDENTIALS (JSON –æ—Ç service principal)
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    # –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Azure (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    - name: ‚úÖ Verify Azure connection
      run: |
        echo "Current Azure subscription:"
        az account show --output table
        echo "Available resource groups:"
        az group list --output table
    
    # –®–ê–ì 4: –°–±–æ—Ä–∫–∞ –∏ –¥–µ–ø–ª–æ–π Container App
    - name: üöÄ Build and deploy Container App
      uses: azure/container-apps-deploy-action@v2
      with:
        # ===== –ò–°–•–û–î–ù–´–ô –ö–û–î =====
        # –ü—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∫–æ–¥—É (–∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)
        appSourcePath: ${{ github.workspace }}
        
        # ===== CONTAINER REGISTRY =====
        # –ò–º—è –≤–∞—à–µ–≥–æ Azure Container Registry
        acrName: ${{ env.ACR_NAME }}
        # –õ–æ–≥–∏–Ω –¥–ª—è Container Registry (–∏–∑ GitHub Secrets)
        acrUsername: ${{ secrets.REGISTRY_USERNAME }}
        # –ü–∞—Ä–æ–ª—å –¥–ª—è Container Registry (–∏–∑ GitHub Secrets)  
        acrPassword: ${{ secrets.REGISTRY_PASSWORD }}
        
        # ===== AZURE –†–ï–°–£–†–°–´ =====
        # –ò–º—è Container App
        containerAppName: ${{ env.CONTAINER_APP_NAME }}

        containerAppEnvironment: ${{ env.CONTAINER_APP_ENVIRONMENT }}

        resourceGroup: ${{ env.RESOURCE_GROUP }}

        location: ${{ env.LOCATION }}
        
        imageToBuild: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
        # –ü—É—Ç—å –∫ Dockerfile (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)
        dockerfilePath: ./Dockerfile
        
        targetPort: 8080
        
        environmentVariables: 'ENVIRONMENT=production NODE_ENV=production'
        
        minReplicas: 1
        
        maxReplicas: 3
